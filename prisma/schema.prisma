generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String                @id @default(cuid())
  email          String                @unique
  password       String
  role           UserRole
  name           String
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  activityLogs   ActivityLog[]
  chatsSent      Chat[]                @relation("ChatFrom")
  chatsReceived  Chat[]                @relation("ChatTo")
  guru           Guru?
  laporanBelajar LaporanBelajarRumah[]
  notifications  Notification[]
  siswaChildren  Siswa[]               @relation("ParentToSiswa")

  @@map("users")
}

model Guru {
  id              String           @id @default(cuid())
  userId          String           @unique
  nip             String?          @unique
  phone           String?
  address         String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  badges          Badge[]
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  jadwalTemu      JadwalTemu[]
  kelas           Kelas[]
  tugas           Tugas[]
  materi          Materi[]
  nilai           Nilai[]
  progressReports ProgressReport[]

  @@map("guru")
}

model Siswa {
  id              String                @id @default(cuid())
  nama            String
  nis             String?               @unique
  kelasId         String
  parentId        String
  pinCode         String?               @unique
  qrCode          String?
  tanggalLahir    DateTime?
  jenisKelamin    String?
  kebutuhanKhusus String?
  catatan         String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  absensi         Absensi[]
  badges          Badge[]
  hasilTugas      HasilTugas[]
  jadwalTemu      JadwalTemu[]
  laporanBelajar  LaporanBelajarRumah[]
  nilai           Nilai[]
  progressReports ProgressReport[]
  kelas           Kelas                 @relation(fields: [kelasId], references: [id])
  parent          User                  @relation("ParentToSiswa", fields: [parentId], references: [id])

  @@map("siswa")
}

model Kelas {
  id          String   @id @default(cuid())
  nama        String
  tingkat     String?
  tahunAjaran String
  guruId      String
  deskripsi   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  guru        Guru     @relation(fields: [guruId], references: [id])
  tugas       Tugas[]
  materi      Materi[]
  siswa       Siswa[]

  @@map("kelas")
}

model Nilai {
  id            String   @id @default(cuid())
  siswaId       String
  guruId        String
  mataPelajaran String
  jenisNilai    String
  nilai         Float
  nilaiMaksimal Float    @default(100)
  catatan       String?
  tanggal       DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  guru          Guru     @relation(fields: [guruId], references: [id])
  siswa         Siswa    @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@map("nilai")
}

model Tugas {
  id            String       @id @default(cuid())
  guruId        String
  kelasId       String?
  judul         String
  deskripsi     String?
  mode          KuisMode
  status        KuisStatus   @default(DRAFT)
  pinCode       String?      @unique
  durasi        Int?
  deadline      DateTime?
  mataPelajaran String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  tanggalTampil DateTime?
  hasilTugas    HasilTugas[]
  guru          Guru         @relation(fields: [guruId], references: [id])
  kelas         Kelas?       @relation(fields: [kelasId], references: [id])
  pertanyaan    Pertanyaan[]

  @@map("kuis")
}

model Pertanyaan {
  id           String    @id @default(cuid())
  tugasId      String    @map("kuisId")
  soal         String
  tipeJawaban  String
  pilihan      Json?
  jawabanBenar String?
  poin         Int       @default(10)
  urutan       Int
  createdAt    DateTime  @default(now())
  jawaban      Jawaban[]
  tugas        Tugas     @relation(fields: [tugasId], references: [id], onDelete: Cascade)

  @@map("pertanyaan")
}

model HasilTugas {
  id           String    @id @default(cuid())
  tugasId      String    @map("kuisId")
  siswaId      String
  skor         Float     @default(0)
  skorMaksimal Float
  waktuMulai   DateTime  @default(now())
  waktuSelesai DateTime?
  createdAt    DateTime  @default(now())
  catatan      String?
  gradedAt     DateTime?
  nilai        Float?
  submittedAt  DateTime?
  videoUrl     String?
  tugas        Tugas     @relation(fields: [tugasId], references: [id], onDelete: Cascade)
  siswa        Siswa     @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  jawaban      Jawaban[]

  @@unique([tugasId, siswaId])
  @@map("hasil_kuis")
}

model Jawaban {
  id           String     @id @default(cuid())
  hasilTugasId String     @map("hasilKuisId")
  pertanyaanId String
  jawaban      String
  benar        Boolean?
  poin         Float      @default(0)
  createdAt    DateTime   @default(now())
  hasilTugas   HasilTugas @relation(fields: [hasilTugasId], references: [id], onDelete: Cascade)
  pertanyaan   Pertanyaan @relation(fields: [pertanyaanId], references: [id], onDelete: Cascade)

  @@map("jawaban")
}

model ProgressReport {
  id           String   @id @default(cuid())
  siswaId      String
  guruId       String
  periode      String
  judulLaporan String
  catatan      String
  perkembangan Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  guru         Guru     @relation(fields: [guruId], references: [id])
  siswa        Siswa    @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@map("progress_reports")
}

model LaporanBelajarRumah {
  id          String        @id @default(cuid())
  siswaId     String
  parentId    String
  tanggal     DateTime      @default(now())
  durasi      Int?
  materi      String
  kendala     String?
  catatan     String?
  mood        String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  dokumentasi Dokumentasi[]
  parent      User          @relation(fields: [parentId], references: [id])
  siswa       Siswa         @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@map("laporan_belajar_rumah")
}

model Dokumentasi {
  id        String              @id @default(cuid())
  laporanId String
  fileUrl   String
  fileType  String
  fileName  String
  fileSize  Int?
  createdAt DateTime            @default(now())
  laporan   LaporanBelajarRumah @relation(fields: [laporanId], references: [id], onDelete: Cascade)

  @@map("dokumentasi")
}

model Chat {
  id         String   @id @default(cuid())
  fromUserId String
  toUserId   String
  siswaId    String?
  message    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  fromUser   User     @relation("ChatFrom", fields: [fromUserId], references: [id])
  toUser     User     @relation("ChatTo", fields: [toUserId], references: [id])

  @@map("chats")
}

model JadwalTemu {
  id        String       @id @default(cuid())
  guruId    String
  parentId  String
  siswaId   String
  tanggal   DateTime
  waktu     String
  topik     String?
  catatan   String?
  status    StatusJadwal @default(PENDING)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  guru      Guru         @relation(fields: [guruId], references: [id])
  siswa     Siswa        @relation(fields: [siswaId], references: [id])

  @@map("jadwal_temu")
}

model Materi {
  id            String   @id @default(cuid())
  guruId        String
  kelasId       String?
  judul         String
  deskripsi     String?
  tipeMateri    String
  fileUrl       String?
  konten        String?
  mataPelajaran String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  guru          Guru     @relation(fields: [guruId], references: [id])
  kelas         Kelas?   @relation(fields: [kelasId], references: [id])

  @@map("materi")
}

model Badge {
  id        String   @id @default(cuid())
  siswaId   String
  guruId    String
  nama      String
  deskripsi String?
  icon      String?
  tipe      String
  earnedAt  DateTime @default(now())
  guru      Guru     @relation(fields: [guruId], references: [id])
  siswa     Siswa    @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@map("badges")
}

model Absensi {
  id         String        @id @default(cuid())
  siswaId    String
  tanggal    DateTime      @default(now())
  status     StatusAbsensi
  keterangan String?
  waktu      DateTime      @default(now())
  createdAt  DateTime      @default(now())
  siswa      Siswa         @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@map("absensi")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  content   String
  type      String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  action      String
  entityType  String?
  entityId    String?
  description String?
  ipAddress   String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("activity_logs")
}

enum UserRole {
  ADMIN
  GURU
  PARENT
}

enum KuisMode {
  LIVE
  HOMEWORK
}

enum KuisStatus {
  DRAFT
  ACTIVE
  CLOSED
}

enum StatusJadwal {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum StatusAbsensi {
  HADIR
  SAKIT
  IZIN
  ALPHA
}
