// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

enum UserRole {
  ADMIN
  GURU
  PARENT
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      UserRole
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  guru           Guru?
  siswaChildren  Siswa[]               @relation("ParentToSiswa")
  chatsSent      Chat[]                @relation("ChatFrom")
  chatsReceived  Chat[]                @relation("ChatTo")
  notifications  Notification[]
  laporanBelajar LaporanBelajarRumah[]
  activityLogs   ActivityLog[]

  @@map("users")
}

// ============================================
// GURU (TEACHER)
// ============================================

model Guru {
  id        String   @id @default(cuid())
  userId    String   @unique
  nip       String?  @unique
  phone     String?
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  kelas           Kelas[]
  nilai           Nilai[]
  tugas           Tugas[]
  progressReports ProgressReport[]
  jadwalTemu      JadwalTemu[]
  materi          Materi[]
  badges          Badge[]

  @@map("guru")
}

// ============================================
// SISWA (STUDENT)
// ============================================

model Siswa {
  id              String    @id @default(cuid())
  nama            String
  nis             String?   @unique
  kelasId         String
  parentId        String
  pinCode         String?   @unique
  qrCode          String?
  tanggalLahir    DateTime?
  jenisKelamin    String?
  kebutuhanKhusus String?
  catatan         String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  kelas           Kelas                 @relation(fields: [kelasId], references: [id])
  parent          User                  @relation("ParentToSiswa", fields: [parentId], references: [id])
  nilai           Nilai[]
  hasilTugas      HasilTugas[]
  progressReports ProgressReport[]
  laporanBelajar  LaporanBelajarRumah[]
  absensi         Absensi[]
  badges          Badge[]
  jadwalTemu      JadwalTemu[]

  @@map("siswa")
}

// ============================================
// KELAS (CLASS)
// ============================================

model Kelas {
  id          String   @id @default(cuid())
  nama        String
  tingkat     String?
  tahunAjaran String
  guruId      String
  deskripsi   String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  guru   Guru     @relation(fields: [guruId], references: [id])
  siswa  Siswa[]
  tugas  Tugas[]
  materi Materi[]

  @@map("kelas")
}

// ============================================
// NILAI (GRADES)
// ============================================

model Nilai {
  id            String   @id @default(cuid())
  siswaId       String
  guruId        String
  mataPelajaran String
  jenisNilai    String // tugas, ujian, sikap, kuis
  nilai         Float
  nilaiMaksimal Float    @default(100)
  catatan       String?  @db.Text
  tanggal       DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  siswa Siswa @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  guru  Guru  @relation(fields: [guruId], references: [id])

  @@map("nilai")
}

// ============================================
// TUGAS (ASSIGNMENT)
// ============================================

enum KuisMode {
  LIVE
  HOMEWORK
}

enum KuisStatus {
  DRAFT
  ACTIVE
  CLOSED
}

model Tugas {
  id            String     @id @default(cuid())
  guruId        String
  kelasId       String?
  judul         String
  deskripsi     String?    @db.Text
  mode          KuisMode
  status        KuisStatus @default(DRAFT)
  pinCode       String?    @unique
  durasi        Int? // dalam menit
  deadline      DateTime?
  tanggalTampil DateTime? // Kapan tugas mulai ditampilkan ke siswa
  mataPelajaran String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  guru       Guru         @relation(fields: [guruId], references: [id])
  kelas      Kelas?       @relation(fields: [kelasId], references: [id])
  pertanyaan Pertanyaan[]
  hasilTugas HasilTugas[]

  @@map("kuis")
}

model Pertanyaan {
  id           String   @id @default(cuid())
  tugasId      String   @map("kuisId")
  soal         String   @db.Text
  tipeJawaban  String // multiple_choice, essay, true_false
  pilihan      Json? // array of choices for multiple choice
  jawabanBenar String? // untuk auto-grading
  poin         Int      @default(10)
  urutan       Int
  createdAt    DateTime @default(now())

  // Relations
  tugas   Tugas     @relation(fields: [tugasId], references: [id], onDelete: Cascade)
  jawaban Jawaban[]

  @@map("pertanyaan")
}

model HasilTugas {
  id           String    @id @default(cuid())
  tugasId      String    @map("kuisId")
  siswaId      String
  skor         Float     @default(0)
  skorMaksimal Float
  waktuMulai   DateTime  @default(now())
  waktuSelesai DateTime?
  createdAt    DateTime  @default(now())

  // New fields for video submission and grading
  videoUrl    String?   @db.Text
  catatan     String?   @db.Text
  nilai       Float?
  gradedAt    DateTime?
  submittedAt DateTime?

  // Relations
  tugas   Tugas     @relation(fields: [tugasId], references: [id], onDelete: Cascade)
  siswa   Siswa     @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  jawaban Jawaban[]

  @@unique([tugasId, siswaId])
  @@map("hasil_kuis")
}

model Jawaban {
  id           String   @id @default(cuid())
  hasilTugasId String   @map("hasilKuisId")
  pertanyaanId String
  jawaban      String   @db.Text
  benar        Boolean?
  poin         Float    @default(0)
  createdAt    DateTime @default(now())

  // Relations
  hasilTugas HasilTugas @relation(fields: [hasilTugasId], references: [id], onDelete: Cascade)
  pertanyaan Pertanyaan @relation(fields: [pertanyaanId], references: [id], onDelete: Cascade)

  @@map("jawaban")
}

// ============================================
// PROGRESS REPORT
// ============================================

model ProgressReport {
  id           String   @id @default(cuid())
  siswaId      String
  guruId       String
  periode      String
  judulLaporan String
  catatan      String   @db.Text
  perkembangan Json? // detailed progress data
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  siswa Siswa @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  guru  Guru  @relation(fields: [guruId], references: [id])

  @@map("progress_reports")
}

// ============================================
// LAPORAN BELAJAR RUMAH
// ============================================

model LaporanBelajarRumah {
  id        String   @id @default(cuid())
  siswaId   String
  parentId  String
  tanggal   DateTime @default(now())
  durasi    Int? // dalam menit
  materi    String   @db.Text
  kendala   String?  @db.Text
  catatan   String?  @db.Text
  mood      String? // rating semangat belajar
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  siswa       Siswa         @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  parent      User          @relation(fields: [parentId], references: [id])
  dokumentasi Dokumentasi[]

  @@map("laporan_belajar_rumah")
}

model Dokumentasi {
  id        String   @id @default(cuid())
  laporanId String
  fileUrl   String
  fileType  String // image, video, pdf
  fileName  String
  fileSize  Int?
  createdAt DateTime @default(now())

  // Relations
  laporan LaporanBelajarRumah @relation(fields: [laporanId], references: [id], onDelete: Cascade)

  @@map("dokumentasi")
}

// ============================================
// CHAT & COMMUNICATION
// ============================================

model Chat {
  id         String   @id @default(cuid())
  fromUserId String
  toUserId   String
  siswaId    String? // context untuk siswa mana
  message    String   @db.Text
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  fromUser User @relation("ChatFrom", fields: [fromUserId], references: [id])
  toUser   User @relation("ChatTo", fields: [toUserId], references: [id])

  @@map("chats")
}

// ============================================
// JADWAL TEMU
// ============================================

enum StatusJadwal {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

model JadwalTemu {
  id        String       @id @default(cuid())
  guruId    String
  parentId  String
  siswaId   String
  tanggal   DateTime
  waktu     String
  topik     String?      @db.Text
  catatan   String?      @db.Text
  status    StatusJadwal @default(PENDING)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relations
  guru  Guru  @relation(fields: [guruId], references: [id])
  siswa Siswa @relation(fields: [siswaId], references: [id])

  @@map("jadwal_temu")
}

// ============================================
// MATERI PEMBELAJARAN
// ============================================

model Materi {
  id            String   @id @default(cuid())
  guruId        String
  kelasId       String?
  judul         String
  deskripsi     String?  @db.Text
  tipeMateri    String // pdf, video, link
  fileUrl       String?
  konten        String?  @db.Text
  mataPelajaran String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  guru  Guru   @relation(fields: [guruId], references: [id])
  kelas Kelas? @relation(fields: [kelasId], references: [id])

  @@map("materi")
}

// ============================================
// GAMIFIKASI
// ============================================

model Badge {
  id        String   @id @default(cuid())
  siswaId   String
  guruId    String
  nama      String
  deskripsi String?
  icon      String?
  tipe      String // achievement, reward, milestone
  earnedAt  DateTime @default(now())

  // Relations
  siswa Siswa @relation(fields: [siswaId], references: [id], onDelete: Cascade)
  guru  Guru  @relation(fields: [guruId], references: [id])

  @@map("badges")
}

// ============================================
// ABSENSI
// ============================================

enum StatusAbsensi {
  HADIR
  SAKIT
  IZIN
  ALPHA
}

model Absensi {
  id         String        @id @default(cuid())
  siswaId    String
  tanggal    DateTime      @default(now())
  status     StatusAbsensi
  keterangan String?       @db.Text
  waktu      DateTime      @default(now())
  createdAt  DateTime      @default(now())

  // Relations
  siswa Siswa @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@map("absensi")
}

// ============================================
// NOTIFICATION
// ============================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  content   String   @db.Text
  type      String // info, warning, success
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ============================================
// ACTIVITY LOG (AUDIT TRAIL)
// ============================================

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  action      String
  entityType  String?
  entityId    String?
  description String?  @db.Text
  ipAddress   String?
  createdAt   DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("activity_logs")
}
